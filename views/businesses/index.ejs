<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Businesses</title>
</head>

<body>
    <h1>All Businesses</h1>
    <a href="/business/new">Add Business</a>

    <!-- 정렬을 위한 드롭다운 메뉴 -->
    <div>
        <label for="sort-options">Sort by:</label>
        <select name="sort" id="sort-options" onchange="sortBusinesses()">
            <option value="a-z">A-Z</option>
            <option value="z-a">Z-A</option>
            <option value="rating-desc">High to Low</option>
            <option value="rating-asc">Low to High</option>
        </select>
    </div>

    <!-- 미션 1: 검색을 위한 입력창 추가 -->
    <div>
        <label for="search">Search:</label>
        <!-- onkeyup="searchBusinesses()"는 키보드를 누를 때마다 searchBusinesses 함수를 실행하라는 뜻입니다. -->
        <input type="text" id="search" onkeyup="searchBusinesses()">
    </div>


    <!-- 가게 목록 -->
    <ul id="business-list">
        <% for (let b of business){%>
        <li class="business-item" data-title="<%= b.title.toLowerCase() %>" data-rating="<%= b.averageRating %>">
            <a href="/business/<%= b._id %>"><%= b.title %></a> - <%= b.averageRating %> &#9733;
        </li>
        <% }%>
    </ul>

    <!-- 미션 2: 정렬 및 검색 로직을 담은 JavaScript 함수 추가 -->
    <script>
        function sortBusinesses() {
            const sortValue = document.getElementById('sort-options').value;
            const list = document.getElementById('business-list');
            const items = list.querySelectorAll('.business-item'); // list.querySelectorAll for accuracy after search

            const itemsArray = Array.from(items);

            itemsArray.sort((a, b) => {
                if (sortValue === 'a-z') {
                    return a.dataset.title.localeCompare(b.dataset.title);
                } else if (sortValue === 'z-a') {
                    return b.dataset.title.localeCompare(a.dataset.title);
                } else if (sortValue === 'rating-desc') {
                    return parseFloat(b.dataset.rating) - parseFloat(a.dataset.rating);
                } else if (sortValue === 'rating-asc') {
                    return parseFloat(a.dataset.rating) - parseFloat(b.dataset.rating);
                }
            });

            // list.innerHTML = ''; // This removes all items, even hidden ones. Let's re-append instead.
            itemsArray.forEach(item => {
                list.appendChild(item);
            });
        }

        function searchBusinesses() {
            // 1. 사용자가 입력한 검색어 값을 가져옵니다. (소문자로 변경)
            const searchTerm = document.getElementById('search').value.toLowerCase();
            
            // 2. 화면에 있는 모든 가게 목록을 가져옵니다.
            const items = document.querySelectorAll('.business-item');

            // 3. 각 가게를 순회하면서, 검색어가 포함되어 있는지 확인합니다.
            items.forEach(item => {
                const title = item.dataset.title; // data-title은 이미 소문자입니다.
                
                // 4. 만약 가게 이름(title)에 검색어(searchTerm)가 포함되어 있다면
                if (title.includes(searchTerm)) {
                    // 해당 가게를 다시 보이게 합니다.
                    item.style.display = ''; 
                } else {
                    // 포함되어 있지 않다면, 해당 가게를 화면에서 숨깁니다.
                    item.style.display = 'none';
                }
            });
        }
    </script>
</body>

</html>